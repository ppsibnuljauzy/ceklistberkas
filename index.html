<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Berkas Santri</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f0f2f5;
            padding-bottom: 90px;
        }
        .navbar {
            backdrop-filter: blur(10px);
            background-color: rgba(13, 110, 253, 0.95) !important;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .search-box {
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            padding-left: 40px;
            transition: 0.3s;
        }
        .search-box:focus {
            border-color: #0d6efd;
            box-shadow: none;
        }
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        .filter-select {
            border-radius: 10px;
            font-size: 0.85rem;
            border: 1px solid #ddd;
        }
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .card-santri {
            border-radius: 16px;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            transition: 0.2s;
        }
        /* Style untuk santri tanpa WA */
        .card-no-wa {
            border-left: 5px solid #dc3545 !important;
        }
        .badge-kelas {
            background-color: #e7f1ff;
            color: #0d6efd;
            font-weight: 600;
        }
        .fab {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(13, 110, 253, 0.4);
            z-index: 999;
        }
        .wa-btn {
            background-color: #25D366;
            color: white;
            border-radius: 10px;
            font-weight: 600;
        }
        .btn-excel {
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .form-check {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            padding: 5px 10px !important;
            border-radius: 8px;
            margin-bottom: 5px;
        }
.card-santri {
    transition: all 0.3s ease;
    border: 1px solid rgba(0,0,0,0.05);
}

.card-santri:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
}

/* Membuat tampilan progress bar lebih halus */
.progress {
    background-color: #f0f0f0;
    overflow: hidden;
}

.progress-bar {
    border-radius: 10px;
    transition: width 1s ease-in-out;
}
.wa-btn {
    background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
    border: none;
    color: white;
    box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3);
}

.wa-btn:hover {
    background: linear-gradient(135deg, #128C7E 0%, #075E54 100%);
    color: white;
}
.item-santri {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

#focusMode:checked + .form-check-label {
    color: #dc3545 !important; /* Berubah jadi merah saat aktif agar waspada */
}

.form-switch .form-check-input {
    width: 2.5em;
    cursor: pointer;
}
#rowsPerPage {
    padding-right: 25px; /* Memberi ruang untuk icon panah select */
    min-width: 70px;
    text-align: center;
}

.pagination-container {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(5px);
    border-top: 1px solid #eee;
    padding: 15px 0;
}
.btn-logout {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 5px 10px;
    border-radius: 10px;
    transition: 0.3s;
}

.btn-logout:hover {
    background: #dc3545;
    color: white;
}
    </style>
</head>
<body>

<nav class="navbar navbar-dark shadow-sm" style="background: linear-gradient(135deg, #0d6efd 0%, #0043a8 100%) !important;">
    <div class="container d-flex justify-content-between align-items-center">
        <div style="width: 40px;"></div> 

        <span class="navbar-brand fw-bold">
            <i class="bi bi-mortarboard-fill me-2"></i>SISTEM BERKAS SANTRI
        </span>

        <button class="btn btn-sm btn-light text-danger fw-bold" onclick="logout()" style="border-radius: 8px;">
            <i class="bi bi-box-arrow-right"></i>
        </button>
    </div>
</nav>

<div class="container mt-3">
    <div class="row g-2 mb-4">
        <div class="col-6">
            <div class="stats-card border-start border-primary border-4 shadow-sm">
                <div class="small text-muted text-uppercase fw-bold" style="font-size: 0.65rem;">Total Santri</div>
                <div class="fw-bold h4 mb-0" id="statTotal">0</div>
            </div>
        </div>
        <div class="col-6">
            <div class="stats-card border-start border-success border-4 shadow-sm">
                <div class="small text-muted text-uppercase fw-bold" style="font-size: 0.65rem;">Berkas Lengkap</div>
                <div class="fw-bold h4 mb-0 text-success" id="statLengkap">0</div>
            </div>
        </div>
    </div>
    
    <div class="d-flex gap-2 mb-3">
        <button class="btn btn-success btn-excel flex-fill" onclick="document.getElementById('fileImport').click()">
            <i class="bi bi-file-earmark-excel me-1"></i> Import
        </button>
        <button class="btn btn-outline-primary btn-excel flex-fill" onclick="exportExcel()">
            <i class="bi bi-download me-1"></i> Export
        </button>
        <button class="btn wa-btn flex-fill" onclick="kirimRekapGrup()">
            <i class="bi bi-whatsapp me-1"></i> Rekap WA
        </button>
        <button class="btn btn-danger btn-excel px-3" onclick="hapusSemuaSantri()" title="Hapus Semua Data">
            <i class="bi bi-trash3-fill"></i>
        </button>
        <button class="btn btn-warning btn-excel flex-fill" data-bs-toggle="modal" data-bs-target="#modalNaikKelas" onclick="inisialisasiMapping()">
            <i class="bi bi-arrow-up-square-fill me-1"></i> Naik Kelas
        </button>
        <input type="file" id="fileImport" hidden accept=".xlsx, .xls" onchange="importExcel(event)">
    </div>

    <div class="bg-white p-3 rounded-4 shadow-sm mb-4">
        <div class="position-relative mb-3">
            <i class="bi bi-search search-icon"></i>
            <input type="text" id="searchInput" class="form-control form-control-lg search-box" placeholder="Cari nama santri..." onkeyup="filterSantri()">
        </div>
        <div class="row g-2">
            <div class="col-6">
                <select id="filterKelas" class="form-select filter-select" onchange="filterSantri()">
                    <option value="">Semua Kelas</option>
                </select>
            </div>
            <div class="col-6">
                <select id="filterStatus" class="form-select filter-select" onchange="filterSantri()">
                    <option value="all">Semua Status</option>
                    <option value="lengkap">Lengkap</option>
                    <option value="belum">Belum Lengkap</option>
                    <option value="no_wa">WhatsApp Kosong</option>
                </select>
            </div>
        </div>
            <div class="d-flex justify-content-between align-items-center mt-3 px-1">
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="focusMode" onchange="filterSantri()">
            <label class="form-check-label small fw-bold text-primary" for="focusMode">
                <i class="bi bi-eye-slash-fill me-1"></i> Sembunyikan Yang Lengkap
            </label>
        </div>
        <div id="countFilter" class="small text-muted fw-bold" style="font-size: 0.7rem;"></div>
    </div>
    </div>

    <div id="loader" class="text-center py-4">
        <div class="spinner-border text-primary spinner-border-sm"></div>
        <p class="small text-muted mt-2">Sinkronisasi Cloud...</p>
    </div>

    <div class="row" id="daftarSantri"></div>
</div>
<div class="container mt-4 mb-5">
    <div class="d-flex flex-column align-items-center justify-content-center">
        <div class="d-flex align-items-center gap-2 mb-2">
            <button class="btn btn-outline-primary btn-sm px-3 shadow-sm" id="btnPrev" onclick="changePage(-1)" style="border-radius: 10px; height: 38px;">
                <i class="bi bi-chevron-left"></i> Prev
            </button>
            
            <select id="rowsPerPage" class="form-select form-select-sm shadow-sm" style="width: auto; border-radius: 8px; height: 38px;" onchange="updateRowsPerPage()">
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>

            <button class="btn btn-outline-primary btn-sm px-3 shadow-sm" id="btnNext" onclick="changePage(1)" style="border-radius: 10px; height: 38px;">
                Next <i class="bi bi-chevron-right"></i>
            </button>
        </div>
        
        <div class="fw-bold text-muted small" id="pageIndicator" style="font-size: 0.7rem;">
            Halaman 1 dari 1
        </div>
    </div>
</div>

<button class="btn btn-primary fab" data-bs-toggle="modal" data-bs-target="#modalTambah">
    <i class="bi bi-plus-lg fs-3"></i>
</button>

<div class="modal fade" id="modalTambah" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered shadow">
        <div class="modal-content border-0" style="border-radius: 20px;">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Input Data Santri</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label small fw-bold">Nama Lengkap</label>
                    <input id="namaSantri" class="form-control bg-light border-0">
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">Kelas</label>
                    <input id="kelasSantri" class="form-control bg-light border-0">
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">WhatsApp Orang Tua</label>
                    <input id="waOrtu" type="number" class="form-control bg-light border-0" placeholder="62xxx">
                </div>
            </div>
            <div class="p-3 pt-0">
                <button class="btn btn-primary w-100 py-3 fw-bold" onclick="simpanSantri()" style="border-radius: 12px;">Simpan</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEdit" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered shadow">
        <div class="modal-content border-0" style="border-radius: 20px;">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Edit Data Santri</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <div class="mb-3">
                    <label class="form-label small fw-bold">Nama Lengkap</label>
                    <input id="editNama" class="form-control bg-light border-0">
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">Kelas</label>
                    <input id="editKelas" class="form-control bg-light border-0">
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">WhatsApp Orang Tua</label>
                    <input id="editWa" type="number" class="form-control bg-light border-0">
                </div>
            </div>
            <div class="p-3 pt-0">
                <button class="btn btn-warning w-100 py-3 fw-bold" onclick="updateSantri()" style="border-radius: 12px;">Simpan Perubahan</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNaikKelas" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 20px;">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold"><i class="bi bi-arrow-up-circle-fill me-2 text-primary"></i>Kenaikan Kelas Massal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info small">
                    Pilih kelas asal dan tentukan kelas tujuannya. Data akan diperbarui secara massal.
                </div>
                <div id="mappingContainer">
                    </div>
                <button class="btn btn-outline-primary btn-sm w-100 mt-2" onclick="tambahBarisMapping()">
                    <i class="bi bi-plus"></i> Tambah Pemetaan Kelas
                </button>
            </div>
            <div class="p-3 pt-0">
                <button class="btn btn-primary w-100 py-3 fw-bold" onclick="eksekusiKenaikanKelas()" style="border-radius: 12px;">Update Sekarang</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPilihSheet" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.2);">
            <div class="modal-header border-0 pt-4 px-4">
                <div class="d-flex align-items-center">
                    <div class="bg-success-subtle p-3 rounded-4 me-3">
                        <i class="bi bi-file-earmark-spreadsheet-fill text-success fs-3"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-bold mb-0">Pilih Sumber Data</h5>
                        <p class="small text-muted mb-0">Tentukan sheet yang akan diimport</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="form-label small fw-bold text-uppercase text-muted">Daftar Sheet Tersedia</label>
                    <select id="selectSheet" class="form-select form-select-lg border-0 bg-light py-3" style="border-radius: 15px; cursor: pointer;">
                        </select>
                </div>
                <div id="infoSheet" class="p-3 rounded-4 bg-primary-subtle border border-primary-subtle" style="display: none;">
                    <div class="d-flex align-items-center text-primary">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <span class="small fw-bold" id="textInfoBaris">Terdeteksi 0 baris data</span>
                    </div>
                </div>
            </div>
            <div class="p-4 pt-0">
                <button id="btnProsesImport" class="btn btn-primary w-100 py-3 fw-bold shadow-sm" style="border-radius: 15px;">
                    <i class="bi bi-cloud-arrow-up-fill me-2"></i>Mulai Import Sekarang
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPIN" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0" style="border-radius: 20px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold mx-auto"><i class="bi bi-shield-lock-fill text-danger me-2"></i>Verifikasi PIN</h5>
            </div>
            <div class="modal-body text-center">
                <p class="small text-muted">Tindakan ini memerlukan PIN Admin</p>
                <input type="password" id="inputPinKeamanan" class="form-control form-control-lg text-center border-0 bg-light" 
                       placeholder="****" maxlength="6" style="letter-spacing: 10px; border-radius: 12px;">
            </div>
            <div class="p-3 pt-0 d-flex gap-2">
                <button type="button" class="btn btn-light flex-fill" data-bs-dismiss="modal" style="border-radius: 10px;">Batal</button>
                <button type="button" id="btnKonfirmasiPin" class="btn btn-primary flex-fill" style="border-radius: 10px;">Konfirmasi</button>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyC2OwjiOar5inkaZJ8PGEJ2N1cKwzD17LI",
    authDomain: "checklit-data.firebaseapp.com",
    projectId: "checklit-data",
    storageBucket: "checklit-data.firebasestorage.app",
    messagingSenderId: "391393842227",
    appId: "1:391393842227:web:5d248e4fc5c0c161b2bf46"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
// Fungsi untuk mengecek status akses saat halaman dimuat
function checkAccess() {
    const sessionAkses = sessionStorage.getItem("isLoggedIn");
    
    if (sessionAkses !== "true") {
        const aksesPin = prompt("Masukkan PIN Akses:");
        if (aksesPin === "123") {
            sessionStorage.setItem("isLoggedIn", "true");
        } else {
            alert("PIN Salah! Anda tidak diizinkan mengakses halaman ini.");
            document.body.innerHTML = "<h1 style='text-align:center; margin-top:50px;'>Akses Ditolak</h1>";
            return false;
        }
    }
    return true;
}

// Jalankan pengecekan
checkAccess();

// Fungsi Log Out
function logout() {
    if (confirm("Apakah Anda yakin ingin keluar?")) {
        sessionStorage.removeItem("isLoggedIn"); // Hapus status login
        location.reload(); // Refresh halaman untuk meminta PIN lagi
    }
}


let currentData = [];


let fungsiSetelahPinBenar = null;
const PIN_ADMIN = "123"; 

function mintaPin(aksi) {
    fungsiSetelahPinBenar = aksi;
    document.getElementById("inputPinKeamanan").value = "";
    const modalElement = document.getElementById('modalPIN');
    const myModal = new bootstrap.Modal(modalElement);
    myModal.show();
}

document.getElementById("btnKonfirmasiPin").addEventListener("click", function() {
    const pinInput = document.getElementById("inputPinKeamanan").value;
    if (pinInput === PIN_ADMIN) {
        const modalElement = document.getElementById('modalPIN');
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        modalInstance.hide();
        if (fungsiSetelahPinBenar) {
            fungsiSetelahPinBenar();
            fungsiSetelahPinBenar = null;
        }
    } else {
        showToast("PIN Salah! Akses Ditolak", "error");
    }
});


function showToast(pesan, tipe = "success") {
    let bgColor = "linear-gradient(to right, #00b09b, #96c93d)";
    if (tipe === "error") bgColor = "linear-gradient(to right, #ff5f6d, #ffc371)";
    if (tipe === "warning") bgColor = "linear-gradient(to right, #f89b29, #feb47b)";

    Toastify({
        text: pesan,
        duration: 3000,
        gravity: "top", 
        position: "right", 
        style: { background: bgColor, borderRadius: "12px", fontWeight: "600" }
    }).showToast();
}

/* KONFIGURASI PAGINASI */
let currentPage = 1;
let rowsPerPage = 10; // Ubah dari const menjadi let
let filteredData = [];

/* DATA HANDLER */
db.collection("santri").orderBy("nama", "asc").onSnapshot(snapshot => {
    document.getElementById("loader").style.display = "none";
    currentData = [];
    let setKelas = new Set();
    let lengkapCount = 0;

    snapshot.forEach(doc => {
        const s = doc.data();
        currentData.push({ id: doc.id, ...s });
        if(s.data_lengkap) lengkapCount++;
        if(s.kelas) setKelas.add(s.kelas);
    });

    document.getElementById("statTotal").innerText = currentData.length;
    document.getElementById("statLengkap").innerText = lengkapCount;
    updateFilterKelas(setKelas);
    
    // Jalankan filter pertama kali untuk mengisi daftar
    filterSantri(); 
});

function filterSantri() {
    const searchVal = document.getElementById("searchInput").value.toLowerCase();
    const kelasVal = document.getElementById("filterKelas").value;
    const statusVal = document.getElementById("filterStatus").value;
    const isFocusMode = document.getElementById("focusMode").checked;

    // Proses Filtering
    filteredData = currentData.filter(s => {
        const isWaKosong = !s.wa || s.wa.toString().trim() === "" || s.wa.toString() === "0";
        const matchSearch = s.nama.toLowerCase().includes(searchVal);
        const matchKelas = kelasVal === "" || s.kelas === kelasVal;
        
        let matchStatus = true;
        if (statusVal === "lengkap") matchStatus = s.data_lengkap;
        if (statusVal === "belum") matchStatus = !s.data_lengkap;
        if (statusVal === "no_wa") matchStatus = isWaKosong;

        const focusFilter = isFocusMode ? !s.data_lengkap : true;

        return matchSearch && matchKelas && matchStatus && focusFilter;
    });

    currentPage = 1; // Reset ke halaman 1 setiap kali filter berubah
    renderTable();
}

function renderTable() {
    const box = document.getElementById("daftarSantri");
    const startIndex = (currentPage - 1) * rowsPerPage;
    const endIndex = startIndex + rowsPerPage;
    const paginatedItems = filteredData.slice(startIndex, endIndex);

    let htmlAccumulator = "";
    
    // Mapping label untuk teks WhatsApp
    const labels = {
        kk: "KK", 
        akta: "Akta Kelahiran", 
        ijazah: "Ijazah", 
        skl: "SKL", 
        ktp_ayah: "KTP Ayah", 
        ktp_ibu: "KTP Ibu",
        foto: "Foto Santri"
    };

    paginatedItems.forEach(s => {
        const id = s.id;
        const isWaKosong = !s.wa || s.wa.toString().trim() === "" || s.wa.toString() === "0";
        const berkas = s.berkas || {}; 
        
        // Hitung Persentase & Warna Bar
        const jumlahTercentang = Object.values(berkas).filter(val => val === true).length;
        const persentase = Math.round((jumlahTercentang / 7) * 100);

        let barColor = "bg-danger";
        if (persentase > 40) barColor = "bg-warning";
        if (persentase > 80) barColor = "bg-info";
        if (persentase === 100) barColor = "bg-success";

        // Logic Pesan WhatsApp
        let kurang = [];
        Object.keys(labels).forEach(key => { 
            if(!berkas[key]) kurang.push(labels[key]); 
        });
        const listKekurangan = kurang.map(item => `    â”•  ${item}`).join("\n");

const pesanWA = `Assalamu'alaikum Warahmatullahi Wabarakatuh.

Segala puji bagi Allah, Shalawat dan salam semoga tercurah kepada Rasulullah.

Ayah/Bunda dari an. *${s.nama}*, mohon maaf mengganggu waktunya. Melalui pesan ini, kami bermaksud menginfokan bahwa masih terdapat beberapa dokumen administrasi santri yang perlu dilengkapi demi tertibnya pendataan:

*BERKAS YANG DIBUTUHKAN:*
${listKekurangan}

*PILIHAN PENGIRIMAN:*
1. Secara Online melalui link berikut: 
https://docs.google.com/forms/d/e/1FAIpQLSfAuK1jrBSW62iFleEWyxZO7m96ZKsK3_BbXNdTkzwf2mMUeQ/viewform
2. Menyerahkan fisik berkas langsung ke Kantor Administrasi Pondok Ibnul Jauzy.

Demikian informasi ini kami sampaikan. Atas perhatian dan kerjasama Ayah/Bunda, kami haturkan:

Jazakumullahu Khairan Katsiran.

Wassalamu'alaikum Warahmatullahi Wabarakatuh.`;

        htmlAccumulator += `
        <div class="col-12 item-santri">
            <div class="card card-santri ${isWaKosong ? 'card-no-wa' : ''}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div>
                            <h6 class="fw-bold mb-0">
                                ${s.nama} 
                                <span class="badge badge-kelas ms-1">${s.kelas}</span>
                                ${isWaKosong ? '<span class="badge bg-danger ms-1" style="font-size:0.6rem">WA KOSONG</span>' : ''}
                            </h6>
                        </div>
                        <div class="d-flex gap-3">
                            <i class="bi bi-pencil-square text-primary fs-5" style="cursor:pointer" onclick="bukaModalEdit('${id}', '${s.nama}', '${s.kelas}', '${s.wa}')"></i>
                            <i class="bi bi-trash text-danger fs-5" style="cursor:pointer" onclick="hapusSantri('${id}')"></i>
                        </div>
                    </div>

                    <div class="d-flex align-items-center gap-2 mb-3">
                        <div class="progress flex-fill" style="height: 10px; border-radius: 10px; background-color: #e9ecef;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated ${barColor}" role="progressbar" style="width: ${persentase}%"></div>
                        </div>
                        <small class="fw-bold text-dark" style="font-size: 0.75rem; min-width: 35px;">${persentase}%</small>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="small text-muted" style="font-size: 0.75rem;">Kelengkapan Berkas:</span>
                        ${s.data_lengkap ? 
                            `<button class="btn btn-sm btn-outline-danger py-0" style="font-size: 0.7rem;" onclick="kosongkanSemuaBerkas('${id}')">
                                <i class="bi bi-x-circle"></i> Kosongkan
                            </button>` : 
                            `<button class="btn btn-sm btn-outline-success py-0" style="font-size: 0.7rem;" onclick="centangSemuaBerkas('${id}')">
                                <i class="bi bi-check-all"></i> Semua
                            </button>`
                        }
                    </div>
                    
                    <div class="row g-2">
                        <div class="col-6 col-md-4">${checkbox(id,'kk',berkas.kk,'KK')}</div>
                        <div class="col-6 col-md-4">${checkbox(id,'akta',berkas.akta,'Akta')}</div>
                        <div class="col-6 col-md-4">${checkbox(id,'ijazah',berkas.ijazah,'Ijazah')}</div>
                        <div class="col-6 col-md-4">${checkbox(id,'skl',berkas.skl,'SKL')}</div>
                        <div class="col-6 col-md-4">${checkbox(id,'ktp_ayah',berkas.ktp_ayah,'KTP Ayah')}</div>
                        <div class="col-6 col-md-4">${checkbox(id,'ktp_ibu',berkas.ktp_ibu,'KTP Ibu')}</div>
                        <div class="col-6 col-md-4">${checkbox(id,'foto',berkas.foto,'Foto Santri')}</div>
                    </div>

                    ${s.data_lengkap ? 
                        `<div class="bg-success-subtle text-success small fw-bold mt-3 p-2 rounded-3 text-center">
                            <i class="bi bi-check-circle-fill me-1"></i> Berkas Lengkap
                        </div>` : 
                        isWaKosong ?
                        `<div class="bg-secondary-subtle text-secondary small fw-bold mt-3 p-2 rounded-3 text-center">
                            <i class="bi bi-exclamation-triangle-fill me-1"></i> No. WA Tidak Tersedia
                        </div>` :
                        `<a href="https://wa.me/${s.wa}?text=${encodeURIComponent(pesanWA)}" target="_blank" class="btn wa-btn btn-sm mt-3 w-100 py-2">
                            <i class="bi bi-whatsapp me-2"></i>Kirim Notif Kekurangan
                        </a>`
                    }
                </div>
            </div>
        </div>`;
    });

    box.innerHTML = htmlAccumulator || `<div class="text-center p-5 text-muted">Data tidak ditemukan</div>`;
    updatePaginationControls();
}

function updatePaginationControls() {
    const totalPages = Math.ceil(filteredData.length / rowsPerPage) || 1;
    document.getElementById("pageIndicator").innerText = `Halaman ${currentPage} dari ${totalPages}`;
    document.getElementById("btnPrev").disabled = currentPage === 1;
    document.getElementById("btnNext").disabled = currentPage === totalPages;
    document.getElementById("countFilter").innerText = `Menampilkan ${filteredData.length} Santri`;
}

function changePage(direction) {
    currentPage += direction;
    renderTable();
    window.scrollTo(0, 0); // Kembali ke atas saat pindah halaman
}

function checkbox(id, field, val, label) {
    const colorClass = val ? 'text-success fw-bold' : 'text-muted';
    const icon = val ? 'bi-check-circle-fill' : 'bi-circle';
    
    return `
    <div class="form-check p-2 m-0 border rounded-3 d-flex align-items-center mb-1 bg-light" style="cursor:pointer" onclick="updateStatus('${id}','${field}',${!val})">
        <i class="bi ${icon} ${val ? 'text-success' : 'text-secondary'} me-2"></i>
        <label class="small ${colorClass}" style="font-size:0.7rem; cursor:pointer">${label}</label>
    </div>`;
}

function updateStatus(id, jenis, status) {
    const ref = db.collection("santri").doc(id);
    ref.update({ [`berkas.${jenis}`]: status }).then(async () => {
        showToast("Status berkas diperbarui");
        const doc = await ref.get();
        const b = doc.data().berkas;
        const lengkap = b.kk && b.akta && b.ijazah && b.skl && b.ktp_ayah && b.ktp_ibu && b.foto;
        ref.update({ data_lengkap: lengkap });
    });
}

async function simpanSantri() {
    const namaInput = document.getElementById("namaSantri").value.trim();
    const kelasInput = document.getElementById("kelasSantri").value.trim();
    let wa = document.getElementById("waOrtu").value.trim();

    if (!namaInput || !kelasInput) return showToast("Nama & Kelas wajib diisi!", "warning");

    if (wa && wa.startsWith('0')) wa = '62' + wa.slice(1);

    try {
        const snapshot = await db.collection("santri").where("kelas", "==", kelasInput).get();
        let isDuplicate = false;
        snapshot.forEach(doc => {
            if (doc.data().nama.toLowerCase() === namaInput.toLowerCase()) isDuplicate = true;
        });

        if (isDuplicate) return showToast("Nama sudah ada di kelas ini!", "error");

        await db.collection("santri").add({
            nama: namaInput, kelas: kelasInput, wa: wa, data_lengkap: false,
            berkas: {
    kk: false, akta: false, ijazah: false, 
    skl: false, ktp_ayah: false, ktp_ibu: false, 
    foto: false}
        });

        showToast("Data berhasil disimpan!");
        bootstrap.Modal.getInstance(document.getElementById('modalTambah')).hide();
        document.getElementById("namaSantri").value = "";
        document.getElementById("kelasSantri").value = "";
        document.getElementById("waOrtu").value = "";
    } catch (e) { showToast("Sistem Error", "error"); }
}

function updateSantri() {
    const id = document.getElementById("editId").value;
    const nama = document.getElementById("editNama").value;
    const kelas = document.getElementById("editKelas").value;
    let wa = document.getElementById("editWa").value;

    if (wa && wa.startsWith('0')) wa = '62' + wa.slice(1);

    db.collection("santri").doc(id).update({ nama, kelas, wa }).then(() => {
        showToast("Perubahan disimpan");
        bootstrap.Modal.getInstance(document.getElementById('modalEdit')).hide();
    });
}

function bukaModalEdit(id, nama, kelas, wa) {
    document.getElementById("editId").value = id;
    document.getElementById("editNama").value = nama;
    document.getElementById("editKelas").value = kelas;
    document.getElementById("editWa").value = wa || "";
    new bootstrap.Modal(document.getElementById('modalEdit')).show();
}

function hapusSantri(id) {
    if(confirm("Hapus data ini?")) {
        db.collection("santri").doc(id).delete().then(() => showToast("Data terhapus", "warning"));
    }
}

function hapusSemuaSantri() {
    // Panggil fungsi verifikasi PIN, baru eksekusi penghapusan
    mintaPin(async () => {
        if (!confirm("Semua data akan dihapus secara permanen. Lanjutkan?")) return;
        
        const validasi = prompt("Ketik 'HAPUS' untuk konfirmasi akhir:");
        if (validasi === "HAPUS") {
            const snapshot = await db.collection("santri").get();
            const batch = db.batch();
            snapshot.docs.forEach((doc) => batch.delete(doc.ref));
            await batch.commit();
            showToast("Semua data berhasil dibersihkan!", "error");
        }
    });
}


let tempWorkbook = null;

async function importExcel(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            tempWorkbook = XLSX.read(data, { type: 'array' });
            
            const sheetNames = tempWorkbook.SheetNames;
            const selectSheet = document.getElementById("selectSheet");
            selectSheet.innerHTML = ""; // Bersihkan pilihan sebelumnya

            sheetNames.forEach(name => {
                const worksheet = tempWorkbook.Sheets[name];
                
                // Logika menghitung baris: XLSX utils decode_range
                const ref = worksheet['!ref'];
                let rowCount = 0;
                if (ref) {
                    const range = XLSX.utils.decode_range(ref);
                    rowCount = range.e.r; // Mendapatkan index baris terakhir (0-indexed)
                }

                const opt = document.createElement("option");
                opt.value = name;
                // Menampilkan nama sheet & jumlah baris di dropdown
                opt.innerText = `${name} (${rowCount} Baris Data)`;
                opt.setAttribute('data-rows', rowCount);
                selectSheet.appendChild(opt);
            });

            // Jalankan fungsi info untuk pertama kali (default index 0)
            updateInfoBaris();

            // Tampilkan Modal
            const modalElement = document.getElementById('modalPilihSheet');
            const modalSheet = new bootstrap.Modal(modalElement);
            modalSheet.show();

            // Pasang event listener saat pilihan dropdown berubah
            selectSheet.onchange = updateInfoBaris;

            // Logika Klik Tombol Import di dalam Modal
            document.getElementById("btnProsesImport").onclick = function() {
                const selectedSheetName = selectSheet.value;
                modalSheet.hide();
                eksekusiImport(selectedSheetName);
            };

        } catch (error) { 
            console.error(error);
            showToast("Gagal membaca file Excel", "error"); 
        } finally {
            // Reset input file agar bisa pilih file yang sama lagi jika gagal
            event.target.value = ''; 
        }
    };
    reader.readAsArrayBuffer(file);
}

// Fungsi untuk mengupdate teks info di dalam modal secara dinamis
function updateInfoBaris() {
    const select = document.getElementById("selectSheet");
    const infoDiv = document.getElementById("infoSheet");
    const textInfo = document.getElementById("textInfoBaris");
    
    if (select.options.length > 0) {
        const selectedOpt = select.options[select.selectedIndex];
        const rows = selectedOpt.getAttribute('data-rows');
        
        infoDiv.style.display = "block";
        textInfo.innerText = `Terdeteksi kurang lebih ${rows} baris data pada sheet ini.`;
    }
}

async function eksekusiImport(sheetName) {
    document.getElementById("loader").style.display = "block";
    
    try {
        const worksheet = tempWorkbook.Sheets[sheetName];
        // Mengubah sheet menjadi JSON
        const json = XLSX.utils.sheet_to_json(worksheet);
        
        // Ambil data yang sudah ada di Firebase untuk cek duplikat
        const snapshot = await db.collection("santri").get();
        const existingData = snapshot.docs.map(doc => ({
            nama: doc.data().nama ? doc.data().nama.toLowerCase().trim() : "",
            kelas: doc.data().kelas ? doc.data().kelas.toString().toLowerCase().trim() : ""
        }));

        let batch = db.batch();
        let countImported = 0;
        let operationCount = 0; 

        for (const row of json) {
            // Sesuaikan key ['Nama Lengkap'] dll dengan header di file Excel kamu
            const namaBaru = row['Nama Lengkap'] ? row['Nama Lengkap'].toString().trim() : null;
            const kelasBaru = row['Kelas'] ? row['Kelas'].toString().trim() : "";
            let waBaru = row['WhatsApp Orang Tua'] ? row['WhatsApp Orang Tua'].toString().trim() : "";
            
            // Format nomor WA ke 62
            if (waBaru.startsWith('0')) waBaru = '62' + waBaru.slice(1);

            if (namaBaru) {
                const isDuplicate = existingData.some(ex => 
                    ex.nama === namaBaru.toLowerCase() && 
                    ex.kelas === kelasBaru.toLowerCase()
                );

                if (!isDuplicate) {
                    const ref = db.collection("santri").doc();
                    batch.set(ref, {
                        nama: namaBaru, 
                        kelas: kelasBaru, 
                        wa: waBaru, 
                        data_lengkap: false,
                        berkas: {
    kk: false, akta: false, ijazah: false, 
    skl: false, ktp_ayah: false, ktp_ibu: false, 
    foto: false}
                    });
                    countImported++;
                    operationCount++;

                    // Batasan Batch Firestore (Maks 500)
                    if (operationCount >= 500) {
                        await batch.commit();
                        batch = db.batch();
                        operationCount = 0;
                    }
                }
            }
        }

        // Commit sisa batch jika ada
        if (operationCount > 0) {
            await batch.commit();
        }

        if (countImported > 0) {
            showToast(`${countImported} data dari sheet [${sheetName}] berhasil diimport!`);
        } else {
            showToast("Tidak ada data baru (semua duplikat atau sheet kosong)", "warning");
        }

    } catch (error) {
        console.error(error);
        showToast("Proses import gagal", "error");
    } finally {
        document.getElementById("loader").style.display = "none";
        tempWorkbook = null; // Hapus data sementara dari memori
    }
}


function exportExcel() {
    if (currentData.length === 0) {
        return showToast("Tidak ada data untuk diekspor", "warning");
    }

    // 1. Siapkan header dan format data
    const dataExport = currentData.map((s, index) => {
        return {
            "No": index + 1,
            "Nama Santri": s.nama,
            "Kelas": s.kelas,
            "WhatsApp": s.wa || "-",
            "KK": s.berkas?.kk ? "Lengkap" : "Belum",
            "Akta": s.berkas?.akta ? "Lengkap" : "Belum",
            "Ijazah": s.berkas?.ijazah ? "Lengkap" : "Belum",
            "SKL": s.berkas?.skl ? "Lengkap" : "Belum",
            "KTP Ayah": s.berkas?.ktp_ayah ? "Lengkap" : "Belum",
            "KTP Ibu": s.berkas?.ktp_ibu ? "Lengkap" : "Belum",
            "Foto": s.berkas?.foto ? "Lengkap" : "Belum",
            "Status Akhir": s.data_lengkap ? "LENGKAP" : "BELUM LENGKAP"
        };
    });

    // 2. Buat Worksheet
    const ws = XLSX.utils.json_to_sheet(dataExport);

    // 3. Atur lebar kolom agar rapi (Opsional)
    const wscols = [
        {wch: 5},  // No
        {wch: 25}, // Nama
        {wch: 10}, // Kelas
        {wch: 15}, // WA
        {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}, // Berkas
        {wch: 15}  // Status Akhir
    ];
    ws['!cols'] = wscols;

    // 4. Buat Workbook dan simpan
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Data Berkas Santri");

    // Tanggal hari ini untuk nama file
    const tgl = new Date().toISOString().split('T')[0];
    XLSX.writeFile(wb, `Rekap_Berkas_Santri_${tgl}.xlsx`);

    showToast("File Excel berhasil diunduh");
}


function centangSemuaBerkas(id) {
    const ref = db.collection("santri").doc(id);
    ref.update({
        "berkas.kk": true,
        "berkas.akta": true,
        "berkas.ijazah": true,
        "berkas.skl": true,
        "berkas.ktp_ayah": true,
        "berkas.ktp_ibu": true,
        "berkas.foto": true, // Pastikan ini ada
        "data_lengkap": true
    }).then(() => {
        showToast("Semua berkas ditandai lengkap", "success");
    });
}

function kosongkanSemuaBerkas(id) {
    if (confirm("Kosongkan semua status berkas santri ini?")) {
        const ref = db.collection("santri").doc(id);
        ref.update({
            "berkas.kk": false,
            "berkas.akta": false,
            "berkas.ijazah": false,
            "berkas.skl": false,
            "berkas.ktp_ayah": false,
            "berkas.ktp_ibu": false,
            "berkas.foto": false, // Pastikan ini ada
            "data_lengkap": false
        }).then(() => {
            showToast("Semua berkas dikosongkan", "warning");
        }).catch((error) => {
            showToast("Gagal mengupdate data", "error");
            console.error(error);
        });
    }
}


function kirimRekapGrup() {
    if (filteredData.length === 0) return showToast("Tidak ada data untuk direkap", "warning");

    let rincianSantri = "";
    filteredData.forEach((s, index) => {
        if (!s.data_lengkap) {
            // Hitung apa saja yang kurang
            let kurang = [];
            const labels = { kk: "KK", akta: "Akta", ijazah: "Ijazah", skl: "SKL", ktp_ayah: "KTP Ayah", ktp_ibu: "KTP Ibu", foto: "Foto" };
            Object.keys(labels).forEach(key => {
                if (!s.berkas || !s.berkas[key]) kurang.push(labels[key]);
            });
            
            // Format ringkas: Nama (Kelas) - Kurang: KK, Akta
            rincianSantri += `${index + 1}. *${s.nama}* (${s.kelas}) - Kurang: ${kurang.join(", ")}\n`;
        }
    });

    if (rincianSantri === "") return showToast("Semua santri di daftar ini sudah lengkap", "success");

    const pesanGrup = `Assalamu'alaikum Warahmatullahi Wabarakatuh.

Segala puji bagi Allah, Shalawat dan salam semoga tercurah kepada Rasulullah.

Berikut kami sampaikan rincian kekurangan berkas administrasi santri Pondok Ibnul Jauzy:

${rincianSantri}
*PILIHAN PENGIRIMAN:*
- Online: https://docs.google.com/forms/d/e/1FAIpQLSfAuK1jrBSW62iFleEWyxZO7m96ZKsK3_BbXNdTkzwf2mMUeQ/viewform
- Langsung: Diantar ke Bagian Administrasi Pondok Ibnul Jauzy.

Mohon bantuan Ayah/Bunda untuk segera melengkapinya. Demikian kami sampaikan.

Jazakumullahu Khairan Katsiran.

Wassalamu'alaikum Warahmatullahi Wabarakatuh.`;

    // Kirim ke WhatsApp (Membuka aplikasi WA dengan pesan yang sudah siap)
    window.open(`https://wa.me/?text=${encodeURIComponent(pesanGrup)}`, '_blank');
}


let daftarKelasUnik = [];

function inisialisasiMapping() {
    // Ambil semua kelas yang ada saat ini dari currentData
    const setKelas = new Set(currentData.map(s => s.kelas));
    daftarKelasUnik = Array.from(setKelas).sort();
    
    const container = document.getElementById("mappingContainer");
    container.innerHTML = ""; // Reset
    
    if(daftarKelasUnik.length === 0) {
        container.innerHTML = "<p class='text-center text-muted'>Tidak ada data kelas.</p>";
        return;
    }

    tambahBarisMapping();
}

function tambahBarisMapping() {
    const container = document.getElementById("mappingContainer");
    const div = document.createElement("div");
    div.className = "row g-2 mb-2 align-items-center mapping-row";
    
    let options = daftarKelasUnik.map(k => `<option value="${k}">${k}</option>`).join("");
    
    div.innerHTML = `
        <div class="col-5">
            <select class="form-select form-select-sm sel-asal">${options}</select>
        </div>
        <div class="col-2 text-center"><i class="bi bi-arrow-right"></i></div>
        <div class="col-5">
            <input type="text" class="form-control form-control-sm inp-tujuan" placeholder="Kelas Baru">
        </div>
    `;
    container.appendChild(div);
}

async function eksekusiKenaikanKelas() {
    const rows = document.querySelectorAll(".mapping-row");
    const batch = db.batch();
    let totalUpdated = 0;

    if (!confirm("Apakah Anda yakin ingin menaikkan kelas seluruh santri yang dipilih? Tindakan ini tidak dapat dibatalkan.")) return;

    document.getElementById("loader").style.display = "block";

    for (let row of rows) {
        const asal = row.querySelector(".sel-asal").value;
        const tujuan = row.querySelector(".inp-tujuan").value.trim();

        if (tujuan === "") continue;

        // Cari santri dengan kelas asal tersebut
        const santriTerdampak = currentData.filter(s => s.kelas === asal);
        
        santriTerdampak.forEach(s => {
            const ref = db.collection("santri").doc(s.id);
            batch.update(ref, { kelas: tujuan });
            totalUpdated++;
        });
    }

    try {
        await batch.commit();
        showToast(`${totalUpdated} santri berhasil naik kelas!`);
        bootstrap.Modal.getInstance(document.getElementById('modalNaikKelas')).hide();
    } catch (error) {
        console.error(error);
        showToast("Gagal memperbarui data", "error");
    } finally {
        document.getElementById("loader").style.display = "none";
    }
}


function updateFilterKelas(setKelas) {
    const select = document.getElementById("filterKelas");
    if (!select) return; // Guard clause jika elemen tidak ditemukan
    
    const currentVal = select.value;
    select.innerHTML = '<option value="">Semua Kelas</option>';
    
    // Mengubah Set menjadi Array dan mengurutkannya
    Array.from(setKelas).sort().forEach(kls => {
        const opt = document.createElement("option");
        opt.value = kls; 
        opt.innerText = kls;
        select.appendChild(opt);
    });
    
    // Mengembalikan pilihan user sebelumnya agar tidak reset saat ada update data
    select.value = currentVal;
}


function updateRowsPerPage() {
    // Ambil nilai dari select dan ubah ke tipe Number
    rowsPerPage = parseInt(document.getElementById("rowsPerPage").value);
    
    // Reset ke halaman 1 agar tidak terjadi error offset
    currentPage = 1; 
    
    // Render ulang tabel
    renderTable();
    
    // Opsional: scroll ke atas
    window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
